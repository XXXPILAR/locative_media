<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Locative Media - Wind Beast Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial; }
    #map { height: 100%; }
    .modal {
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center;
    }
    .modal-content img {
      max-width: 100%;
      width: 160px;
      height: auto;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .modal-content button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
    }
    .modal-content button:hover { background-color: #388e3c; }
    #inventoryButton, #clueButton, #healthBar {
      position: absolute;
      z-index: 1000;
      background-color: #ffffffcc;
      border: 1px solid #999;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: bold;
      cursor: pointer;
    }

    #inventoryButton {
      top: 10px;
      left: 10px;
    }

    #clueButton {
      top: 60px; /* ç¨å¾®å¾€ä¸‹ï¼Œé¿å…è·ŸCardsæŒ‰é’®é‡å  */
      left: 10px;
    }

    #healthBar {
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    #scanButton {
        top: 110px;
        left: 10px;
        position: absolute;
        z-index: 1000;
        background-color: #ffffffcc;
        border: 1px solid #999;
        border-radius: 8px;
        padding: 6px 10px;
        font-weight: bold;
        cursor: pointer;
    }

    #closeScannerBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: none;
        font-size: 36px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001; /* é«˜äºvideo */
    }

    #investigationModal .modal-content {
      width: 90%;
      max-width: 500px;
      max-height: 90%;
      overflow-y: auto;
      padding: 20px;
    }

    @keyframes bossHit {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-5px, 0) rotate(-5deg); }
      50% { transform: translate(5px, 0) rotate(5deg); }
      75% { transform: translate(-5px, 0) rotate(-5deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }

    @keyframes buttonPress {
      0% { transform: scale(1); }
      50% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }

    /* çˆ†ç‚¸ç²’å­é£æ•£åŠ¨ç”» */
    @keyframes explode {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
    }

    .explosion {
      position: absolute;
      width: 8px;
      height: 8px;
      background: gold;
      border-radius: 50%;
      pointer-events: none;
      animation: explode 0.6s forwards;
      z-index: 1002;
    }

    @keyframes victoryBounce {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    .victory-animate {
      animation: victoryBounce 0.8s ease-out;
    }

    @keyframes screenShake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-10px, 5px); }
      40% { transform: translate(8px, -8px); }
      60% { transform: translate(-5px, 5px); }
      80% { transform: translate(5px, -5px); }
      100% { transform: translate(0, 0); }
    }

    .screen-shake {
      animation: screenShake 0.5s ease;
    }
    .option-button {
      padding: 10px 16px;
      font-size: 16px;
      border: 1px solid #888;
      border-radius: 8px;
      background-color: #f0f0f0;
      cursor: pointer;
      width: 45%; /* âœ… è®©æ¯ä¸ªæŒ‰é’®æœ€å¤šå ä¸€åŠ */
      margin: 5px;
    }

    .option-button:hover {
      background-color: #ddd;
    }

    /* âœ… æ–°å¢ï¼šåŒ…è£¹æŒ‰é’®çš„å®¹å™¨ï¼Œè®©å®ƒå˜æˆflexå¸ƒå±€æ¢è¡Œ */
    .option-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    #challengeModal img {
      max-width: 60%;
      margin: 20px auto;
    }

    #investigationModal,
    #challengeModal {
      z-index: 3000 !important;
    }

    #investigationModal img {
      max-width: 80%;
      height: auto;
    }


  </style>
</head>
<body>
  <div id="map"></div>
  <div id="inventoryButton" onclick="toggleInventory()">ğŸ“¦ Cards</div>
  <div id="clueButton" onclick="toggleClues()">ğŸ§© Clues</div>
  <div id="scanButton" onclick="startScanner()">ğŸ“¸ Scan</div>
  <div id="healthBar"> <span id="hearts"></span></div>

  <div id="challengeModal" class="modal">
    <div class="modal-content">
      <h2>You encountered Wind Beast! ğŸŒ¬ï¸</h2>
      <img src="wind_beast.png" alt="Wind Beast" />
      <p>Do you accept the challenge?</p>
      <button onclick="acceptChallenge()">Accept Challenge</button>
      <button onclick="closeModal()">Run Away</button>
    </div>
  </div>

  <div id="quizModal" class="modal">
    <div class="modal-content">
      <h2 id="quizTitle">Quiz</h2>
      <p id="question"></p>
      <!-- åŠ¨æ€æ’å…¥é€‰é¡¹æŒ‰é’®çš„ä½ç½® -->
    </div>
  </div>

  <div id="puzzleModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ§© Solve the Puzzle to Tame Smart Goose!</h2>
      <h3 id="timer" style="margin-bottom: 10px;">â³ 60</h3>
      <div id="puzzleGrid" style="display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 2px; justify-content: center; margin-bottom: 20px;"></div>
      <button onclick="checkPuzzle()">Check</button>
      <button onclick="closeResultModal('puzzleModal')">Leave</button>
    </div>
  </div>


  <div id="successModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ‰ You Tamed Wind Beast!</h2>
      <img src="wind_beast.png" alt="Wind Beast" />
      <p>The wind flows with you now. Congratulations!</p>
      <button onclick="closeResultModal('successModal')">OK</button>
    </div>
  </div>

  <div id="failModal" class="modal">
    <div class="modal-content">
      <h2 id="failTitle">ğŸ˜¢ Challenge Failed</h2>
      <img id="failImage" src="wind_beast.png" alt="Beast" />
      <p id="failMessage">The Wind Beast slipped away. Try again later.</p>
      <button onclick="retryChallenge()">Retry</button>
      <button onclick="handleFailRetry()">Leave</button>
    </div>
  </div>

  <div id="gameOverModal" class="modal">
    <div class="modal-content">
      <h2>âŒ Game Over</h2>
      <p>Your journey ends here... for now.</p>
      <button onclick="restartGame()">Restart Game</button>
    </div>
  </div>

  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ“œ Your Beast Cards</h2>
      <div id="inventoryContent">
        <p>No tamed beasts yet.</p>
      </div>
      <button onclick="closeResultModal('inventoryModal')">Close</button>
    </div>
  </div>

  <div id="clueModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ§© Your Clues</h2>
      <div id="clueContent">
        <p>No clues collected yet.</p>
      </div>
      <button onclick="closeResultModal('clueModal')">Close</button>
    </div>
  </div>

  <div id="clueRewardModal" class="modal">
    <div class="modal-content">
      <h2 id="clueRewardTitle">ğŸ§© You found a clue!</h2>
      <img id="clueRewardImage" src="" alt="Clue Piece" />
      <p id="clueRewardText">Wind Beast left you a mysterious clue...</p>
      <button onclick="collectClue()">Collect</button>
    </div>
  </div>

  <div id="scanNoticeModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ“¸ Ready to Scan!</h2>
      <p>You have collected enough clues. Find and scan the hidden poster to summon the BOSS!</p>
      <button onclick="startScanPage()">OK</button>
    </div>
  </div>

  <div id="bossEncounterModal" class="modal">
    <div class="modal-content">
      <h2>You found the BOSS!!!</h2>
      <img src="boss.png" alt="Boss" style="width: 200px; height: auto; margin: 20px 0;">
      <p>The final battle awaits. Are you ready?</p>
      <button onclick="startBossBattle()">Challenge Boss</button>
    </div>
  </div>

  <div id="trapModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ’€ Trap Triggered!</h2>
      <p>You fell into UoN King's trap!</p>
      <button onclick="handleTrapOk()">OK</button>
    </div>
  </div>

  <div id="scannerModal" class="modal" style="background: rgba(0,0,0,0.9);">
    <div id="scannerVideo" style="width: 100%; height: 100%;"></div>
    <button onclick="closeScanner()" id="closeScannerBtn">Ã—</button>
  </div>

  <div id="bossBattleModal" class="modal">
    <div class="modal-content" style="position: relative;">
      <div style="position: relative; margin-bottom: 10px;">
        <div id="bossHealthBarBackground" style="width: 100%; height: 20px; background: grey; border-radius: 10px; overflow: hidden;">
          <div id="bossHealthBar" style="width: 100%; height: 100%; background: red; transition: width 0.2s;"></div>
        </div>
      </div>
  
      <h2>âš”ï¸ Boss Battle!</h2>
      <p style="font-size: 18px; color: #444;">ğŸ”¥ Tap quickly to defeat the Boss before your health runs out!</p>
      <img id="bossImage" src="boss.png" alt="Boss" style="width: 200px; height: auto; margin: 20px 0;">
      <button onclick="attackBoss()">Attack!</button>
    </div>
  </div>

  <div id="kingModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ‘‘ You are now the King of UoN!</h2>
      <p style="font-size: 20px;">You have already defeated the Boss!</p>
      <button onclick="closeResultModal('kingModal')">OK</button>
    </div>
  </div>

  <div id="soundPromptModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ”Š Enable Sound?</h2>
      <p>Would you like to enable sound effects during your journey?</p>
      <button onclick="enableSound()">Yes</button>
      <button onclick="disableSound()">No</button>
    </div>
  </div>

  <div id="startPointModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ¯ Reach the Starting Point</h2>
      <p>Walk to the starting location to begin your journey!</p>
      <button onclick="closeStartPointModal()">OK</button>
    </div>
  </div>

  <div id="investigationModal" class="modal">
    <div class="modal-content">
      <h2>Suspicious Activity Nearby âŒ</h2>
      <p>In UoN, a mysterious entity now reigns from the shadowsâ€”unseen, unnamed.
      No one has ever laid eyes on itâ€¦ yet everyone can feel its presence. The location marked on the map is believed to be the epicenter of these attacks.
      It is said to be cursed. Haunted. Forgotten. Head to the island and investigate the truth.</p>
      <img src="map_hint.png" alt="Map Hint" style="width: 100%; border-radius: 12px; margin: 15px 0;">
      <button onclick="closeInvestigationModal()">OK</button>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    let map, userMarker;
    let activeBeast = null; // tracks which beast you're challenging
    let quizStarted = false, hasEncountered = {}, health = 3, inventory = [], current = 0;

    const threshold = 15;
    const beasts = [
      {
        name: "Wind Beast",
        lat: 52.9530606,
        lng: -1.1879390,
        icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        image: "wind_beast.png",
        sound: "wind_beast_sound.mp3",  
        activated: false,
        hidden: false,
        questions: [
          {
            q: "Which of these is associated with Wind Beast?",
            options: ["Flames", "Breeze", "Lava", "Rock"],
            correct: "Breeze"
          },
          {
            q: "What is the Wind Beastâ€™s greatest strength?",
            options: ["Speed", "Wisdom", "Fire", "Water control"],
            correct: "Wisdom"
          },
          {
            q: "What tames the Wind Beast?",
            options: ["Strength", "Kindness", "Fear", "Money"],
            correct: "Kindness"
          },
          {
            q: "Which word contains the same root as 'respire'?",
            options: ["Spirit", "Fire", "Roar", "Burn"],
            correct: "Spirit"
          },
          {
            q: "Decipher: 'W_N_' (Hint: A force that moves)",
            options: ["Wind", "Wand", "Wane", "Worn"],
            correct: "Wind"
          }
        ]
        
      },
      {
        name: "Water Beast",
        lat: 52.9525235,
        lng: -1.1872942,
        icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        image: "water_beast.png",
        sound: "water_beast_sound.mp3",
        activated: false,
        hidden: true , 
      }
    ];

    let markers = {}; // save markers by name

    function initMap() {

      const startPoint = {
        lat: 52.9521782,   // âœ¨ ä½ æŒ‡å®šçš„èµ·ç‚¹çº¬åº¦
        lng: -1.1867980,   // âœ¨ ä½ æŒ‡å®šçš„èµ·ç‚¹ç»åº¦
      };

      map = L.map('map').setView([beasts[0].lat, beasts[0].lng], 17);
      L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png?api_key=724f6bff-ee73-4e21-97aa-b0f55c520723').addTo(map);


      const startMarker = L.marker([startPoint.lat, startPoint.lng], {
        icon: L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize: [32, 32] })
      }).addTo(map).bindPopup("ğŸ Starting Point").openPopup();

      const userIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize: [32, 32] });

      beasts.forEach(beast => {
        const marker = L.marker([beast.lat, beast.lng], {
          icon: L.icon({ iconUrl: beast.icon, iconSize: [32, 32] })
        });
        markers[beast.name] = marker;

        marker.on('click', () => {
          if (!quizStarted && userMarker && beast.activated) {
            const dist = getDistance(userMarker.getLatLng(), marker.getLatLng());

            if (hasEncountered[beast.name]) {
              // âœ…å·²ç»é‡åˆ°è¿‡
              if (dist < threshold && !inventory.includes(beast.name)) {
                
                // â­ è·ç¦»å¤Ÿè¿‘ï¼Œç›´æ¥æŒ‘æˆ˜
                activeBeast = beast;
                document.querySelector('#challengeModal h2').textContent = `You encountered ${beast.name}!`;
                document.querySelector('#challengeModal img').src = beast.image;
                document.querySelector('#challengeModal').style.display = 'flex';
              } else {
                // ğŸ‘€ è·ç¦»å¤ªè¿œï¼Œæ˜¾ç¤ºæ­£å¸¸æç¤º
                marker.bindPopup(`${beast.name} is here. Come closer to challenge!`).openPopup();
              }
            } else {
              // ğŸ§©ä»æœªé‡åˆ°è¿‡ï¼Œåªèƒ½æ„ŸçŸ¥ç¥ç§˜æ„Ÿ
              marker.bindPopup(`You sense a mysterious presenceâ“`).openPopup();
            }
          }
        });
      });
      navigator.geolocation.watchPosition(
        pos => {
          const latlng = [pos.coords.latitude, pos.coords.longitude];

          if (!userMarker) {
            userMarker = L.circleMarker(latlng, {
              radius: 10,
              color: '#0066FF',
              fillColor: '#3399FF',
              fillOpacity: 1,
              weight: 2
            }).addTo(map).bindPopup("You are here");
          } else {
            userMarker.setLatLng(latlng); 
          }

          if (!beastSystemActivated) {
            const distToStart = getDistance(userMarker.getLatLng(), startPoint);
            if (distToStart < 20) {
              beastSystemActivated = true;
              activateBeasts();
              map.removeLayer(startMarker);
              document.getElementById("investigationModal").style.display = "flex";
            }
            return; // ğŸš« æ²¡åˆ°èµ·ç‚¹ä¹‹å‰ï¼Œä¸ç»§ç»­æ£€æµ‹å…¶ä»–äº‹ä»¶ï¼
          }

          // âœ… åˆ°äº†èµ·ç‚¹åï¼ŒåŠ å…¥ Goose Marker å£°éŸ³è§¦å‘é€»è¾‘
          const gooseDist = getDistance(userMarker.getLatLng(), gooseHintMarker);
          if (gooseDist < 20 && !gooseHintMarker.played && soundEnabled) {
            setTimeout(() => {
              const gooseSound = document.getElementById("leftGooseSound");
              if (gooseSound && !gooseHintMarker.played) {
                gooseSound.play()
                  .then(() => {
                    gooseHintMarker.played = true; // âœ… æ’­æ”¾æˆåŠŸåå†æ ‡è®°
                    console.log("Goose sound played successfully");
                  })
                  .catch(err => {
                    console.warn("Goose sound failed to play:", err);
                  });
              }
            }, 1000); // âœ… å»¶è¿Ÿ 4 ç§’ï¼Œé¿å…å’Œ Beast å£°éŸ³å†²çª
          }

          // âœ… æ£€æŸ¥é™„è¿‘beastsï¼Œä¼˜å…ˆæ’­æ”¾æœ€è¿‘çš„ä¸€ä¸ª
          let nearbyBeasts = beasts
            .map(beast => ({
              beast,
              dist: getDistance(userMarker.getLatLng(), { lat: beast.lat, lng: beast.lng })
            }))
            .filter(item => item.dist < 30 && soundEnabled && (hasPlayedSound[item.beast.name] === false || hasPlayedSound[item.beast.name] === undefined))
            .sort((a, b) => a.dist - b.dist);

          if (nearbyBeasts.length > 0) {
            const { beast } = nearbyBeasts[0];
            if (beastSounds[beast.name]) {
              beastSounds[beast.name].play();
              beastSounds[beast.name].addEventListener('ended', function handler() {
                beastSounds[beast.name].removeEventListener('ended', handler); // æ’­æ”¾å®Œç¬¬ä¸€éåï¼Œç§»é™¤ç›‘å¬
                hasPlayedSound[beast.name] = true;
                beastSounds[beast.name].play();        // å†æ’­æ”¾ç¬¬äºŒéï¼
              });
            }
          }

          // âœ… æ£€æŸ¥é‡åˆ°beastï¼Œå¼¹å‡ºæŒ‘æˆ˜
          beasts.forEach(beast => {
            const dist = getDistance(userMarker.getLatLng(), { lat: beast.lat, lng: beast.lng });
            if (dist < threshold && (hasEncountered[beast.name] === false || hasEncountered[beast.name] === undefined)) {

              if (beast.hidden) {
                markers[beast.name].addTo(map);  // âœ… æ˜¾ç¤º marker
                beast.hidden = false;            // âœ… ä¸å†éšè—
              }

              hasEncountered[beast.name] = true; 
              activeBeast = beast;
              document.querySelector('#challengeModal h2').textContent = `You encountered ${beast.name}!`;
              document.querySelector('#challengeModal img').src = beast.image;
              document.querySelector('#challengeModal').style.display = 'flex';
            }
          });

        },
        err => {
          console.error("Geolocation error:", err);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        }
      );
    }

    function getDistance(a, b) {
      const R = 6371e3, toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const aCalc = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(aCalc), Math.sqrt(1-aCalc));
    }


    function closeModal() {
      document.getElementById("challengeModal").style.display = "none";
      showTopButtons();
    }

    function showQuestion() {
      const questionObj = activeBeast.questions[current];
      document.getElementById("question").textContent = questionObj.q;

      const container = document.getElementById("quizModal");
      container.querySelectorAll(".option-button").forEach(b => b.remove());

      let optionBox = container.querySelector(".option-container");
      if (optionBox) optionBox.remove(); // æ¸…ç†æ—§çš„

      optionBox = document.createElement("div");
      optionBox.className = "option-container"; // âœ… æ·»åŠ æ ·å¼

      questionObj.options.forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.className = "option-button";
        btn.onclick = () => answer(option);
        optionBox.appendChild(btn);
      });

      container.querySelector(".modal-content").appendChild(optionBox);
    }

    function answer(ans) {
      if (ans === activeBeast.questions[current].correct) {
        current++;
        if (current >= activeBeast.questions.length) return tameSuccess();
        return showQuestion();
      } else {
        // åŸæœ‰å¤±è´¥é€»è¾‘ä¿æŒä¸å˜
        document.getElementById("quizModal").style.display = "none";
        health = Math.max(0, health - 1);
        updateHearts();

        document.getElementById("failTitle").textContent = `ğŸ˜¢ Challenge Failed`;
        document.getElementById("failImage").src = activeBeast.image;
        document.getElementById("failMessage").textContent = `The ${activeBeast.name} slipped away. Try again later.`;

        quizStarted = false;
        if (health <= 0) {
          document.getElementById("gameOverModal").style.display = "flex";
        } else {
          document.getElementById("failModal").style.display = "flex";
        }
      }
    }

    function tameSuccess() {
        document.getElementById("quizModal").style.display = "none";
        document.querySelector("#successModal h2").textContent = `ğŸ‰ You Tamed ${activeBeast.name}!`;
        document.querySelector("#successModal img").src = activeBeast.image;
        document.getElementById("successModal").style.display = "flex";

        const successMessage = document.querySelector("#successModal p");
        if (activeBeast.name === "Wind Beast") {
          successMessage.textContent = "The wind flows with you now. Congratulations!";
        } else if (activeBeast.name === "Water Beast") {
          successMessage.textContent = "You now command the tides. Power surges beneath your feet!";
        } else {
          successMessage.textContent = "Congratulations!";
        }

        document.getElementById("successModal").style.display = "flex";

        if (map.hasLayer(markers[activeBeast.name])) map.removeLayer(markers[activeBeast.name]);

        if (!inventory.includes(activeBeast.name)) {
            inventory.push(activeBeast.name);
            const inventoryContent = document.getElementById("inventoryContent");
            if (inventoryContent.innerHTML.includes("No tamed beasts yet.")) {
            inventoryContent.innerHTML = '';
            }
            inventoryContent.innerHTML += `<div style="display: inline-block; margin: 10px;"><img src="${activeBeast.image}" style="width: 100px; height: 100px;"><p>${activeBeast.name}</p></div>`;
        }

        quizStarted = false;
        hasEncountered[activeBeast.name] = "tamed";

        // â­ ç›‘å¬"OK"æŒ‰é’®ï¼Œå½“æˆåŠŸå¼¹çª—å…³é—­åï¼Œç«‹åˆ»å¼¹å‡ºçº¿ç´¢å¥–åŠ±
        const okButton = document.querySelector("#successModal button");
        okButton.onclick = () => {
            document.getElementById("successModal").style.display = "none";
            showClueReward();
        };
        }

    function retryChallenge() {
      document.getElementById("failModal").style.display = "none";
      acceptChallenge(); 
    }

    function handleFailRetry() {
      document.getElementById("failModal").style.display = "none";
      showTopButtons(); 
    }

    function restartGame() { location.reload(); }

    function closeResultModal(id) {
      document.getElementById(id).style.display = "none";
      showTopButtons(); 
    }

    function toggleInventory() {
      const inv = document.getElementById("inventoryModal");
      inv.style.display = inv.style.display === "flex" ? "none" : "flex";
    }
    function toggleClues() {
      const clue = document.getElementById("clueModal");
      clue.style.display = clue.style.display === "flex" ? "none" : "flex";
    }

    function updateHearts() {
      const hearts = document.getElementById("hearts");
      hearts.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        hearts.innerHTML += i < health ? 'â¤ï¸' : 'ğŸ¤';
      }
    }
    
  const puzzlePieces = [];

  let selectedPiece = null;

  function selectPiece(piece) {
    if (!selectedPiece) {
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œé€‰ä¸­
      selectedPiece = piece;
      piece.style.border = "2px solid red"; // æ˜¾ç¤ºçº¢è‰²è¾¹æ¡†ä½œä¸ºæç¤º
    } else {
      // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œäº¤æ¢ä½ç½®
      const tempPos = selectedPiece.style.backgroundPosition;
      selectedPiece.style.backgroundPosition = piece.style.backgroundPosition;
      piece.style.backgroundPosition = tempPos;

      selectedPiece.style.border = "none";
      piece.style.border = "none";

      selectedPiece = null; // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
    }
  }

  function startPuzzleChallenge() {
    hideTopButtons(); 
    disableMapInteraction(); 
    const puzzleGrid = document.getElementById("puzzleGrid");
    puzzleGrid.innerHTML = "";
    puzzlePieces.length = 0;

    for (let i = 0; i < 9; i++) {
      const piece = document.createElement("div");
      piece.style.width = "100px";
      piece.style.height = "100px";
      piece.style.backgroundImage = "url('clue2.png')"; // âœ…æ”¹å°å†™
      piece.style.backgroundSize = "300px 300px";
      piece.style.backgroundPosition = `${-(i % 3) * 100}px ${-Math.floor(i / 3) * 100}px`;
      piece.dataset.index = i;
      piece.onclick = () => selectPiece(piece); // â­ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶
      puzzlePieces.push(piece);
    }

    shuffleArray(puzzlePieces);
    puzzlePieces.forEach(p => puzzleGrid.appendChild(p));

    document.getElementById("puzzleModal").style.display = "flex";

    quizStarted = true;
    startTimer();
  }

  function dragStart(e) {
    e.dataTransfer.setData("text/plain", e.target.dataset.index);
  }

  function drop(e) {
    const fromIdx = e.dataTransfer.getData("text/plain");
    const toIdx = e.target.dataset.index;
    const parent = e.target.parentElement;
    const fromEl = puzzlePieces[fromIdx];
    const toEl = puzzlePieces[toIdx];

    // Swap in DOM
    const temp = fromEl.cloneNode(true);
    parent.replaceChild(temp, toEl);
    parent.replaceChild(toEl, fromEl);

    // Re-bind drag events
    parent.childNodes.forEach((child, i) => {
      child.dataset.index = i;
      child.ondragstart = dragStart;
      child.ondragover = e => e.preventDefault();
      child.ondrop = drop;
      puzzlePieces[i] = child;
    });
  }


  let timerInterval; // è®¡æ—¶å™¨å¥æŸ„
  let remainingTime = 60; // å‰©ä½™æ—¶é—´ï¼Œç§’

  function startTimer() {
    remainingTime = 60;
    document.getElementById("timer").textContent = `â³ ${remainingTime}`;
    clearInterval(timerInterval); // é˜²æ­¢å¤šå¼€

    timerInterval = setInterval(() => {
      remainingTime--;
      document.getElementById("timer").textContent = `â³ ${remainingTime}`;
      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        checkPuzzle(true); // æ—¶é—´åˆ°äº†è‡ªåŠ¨æ£€æŸ¥
      }
    }, 1000);
  }

  // isAuto è¡¨ç¤ºæ˜¯ä¸æ˜¯è‡ªåŠ¨æ£€æŸ¥
  function checkPuzzle(isAuto = false) {
    clearInterval(timerInterval); // æ— è®ºæ€æ ·éƒ½åœæ‰è®¡æ—¶å™¨
    enableMapInteraction();   // æ¢å¤åœ°å›¾äº¤äº’

    const correctOrder = [0,1,2,3,4,5,6,7,8];
    const currentOrder = Array.from(document.getElementById("puzzleGrid").children).map(el => {
      const bgPos = el.style.backgroundPosition;
      const x = parseInt(bgPos.split(" ")[0]) * -1 / 100;
      const y = parseInt(bgPos.split(" ")[1]) * -1 / 100;
      return y * 3 + x;
    });

    const isCorrect = currentOrder.every((val, idx) => val === correctOrder[idx]);

    if (isCorrect) {
      document.getElementById("puzzleModal").style.display = "none";
      tameSuccess();
    } else {
      document.getElementById("puzzleModal").style.display = "none";
      health = Math.max(0, health - 1);
      updateHearts();
      document.getElementById("failTitle").textContent = `ğŸ˜¢ Puzzle Failed`;
      document.getElementById("failImage").src = activeBeast.image;
      document.getElementById("failMessage").textContent = isAuto 
        ? `Time's up! ${activeBeast.name} slipped away.` 
        : `Wrong puzzle arrangement! ${activeBeast.name} slipped away.`;

      if (health <= 0) {
        document.getElementById("gameOverModal").style.display = "flex";
      } else {
        document.getElementById("failModal").style.display = "flex";
      }
      quizStarted = false;
    }
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Update the acceptChallenge() logic to launch quiz or puzzle based on beast
  function acceptChallenge() {
    document.getElementById("challengeModal").style.display = "none";
    current = 0; // é‡ç½®é—®é¢˜ç´¢å¼•
    hideTopButtons(); // ğŸ‘ˆ åŠ ä¸Šè¿™å¥ï¼

    if (activeBeast.name === "Water Beast") {
      startPuzzleChallenge();
    } else {
      quizStarted = true;
      document.getElementById("quizModal").style.display = "flex";
      showQuestion();
    }
  }

  function disableMapInteraction() {
    map.dragging.disable();
    map.scrollWheelZoom.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
  }

  function enableMapInteraction() {
    map.dragging.enable();
    map.scrollWheelZoom.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
  }
  let collectedClues = []; // ä¿å­˜å·²ç»è·å¾—çš„çº¿ç´¢ç¢ç‰‡
    const clues = {
    "Wind Beast": "clue1.png",
    "Water Beast": "clue2.png"
    };

    function showClueReward() {
        const clueImg = clues[activeBeast.name];
        if (clueImg && !collectedClues.includes(clueImg)) {
            document.getElementById("clueRewardImage").src = clueImg;
            document.getElementById("clueRewardText").textContent = `${activeBeast.name} gave you a clue piece!`;
            document.getElementById("clueRewardModal").style.display = "flex";
        }
        }

    let scanPromptShown = false;    
    function collectClue() {
        const clueImg = document.getElementById("clueRewardImage").src;
        collectedClues.push(clueImg);

        const clueContent = document.getElementById("clueContent");
        if (clueContent.innerHTML.includes("No clues collected yet.")) {
            clueContent.innerHTML = '';
        }
        clueContent.innerHTML += `<div style="display: inline-block; margin: 10px;"><img src="${clueImg}" style="width: 100px; height: 100px;"></div>`;

        document.getElementById("clueRewardModal").style.display = "none";

        showTopButtons();  

        // ğŸ§©â­ã€æ–°å¢ã€‘æ”¶é›†ä¸¤ä¸ªçº¿ç´¢åæç¤ºå¯ä»¥å»æ‰«æ
        if (collectedClues.length >= 2 && !scanPromptShown) {
            scanPromptShown = true;
            showScanPrompt();
        }
    }

    let html5QrScanner = null; // ä¿å­˜scannerå¯¹è±¡

    function startScanner() {
        if (html5QrScanner) return;

        // ğŸ‘‡éšè—ç•Œé¢ä¸Šçš„æŒ‰é’®
        document.getElementById("inventoryButton").style.display = "none";
        document.getElementById("clueButton").style.display = "none";
        document.getElementById("scanButton").style.display = "none";
        document.getElementById("healthBar").style.display = "none";

        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "flex";

        html5QrScanner = new Html5Qrcode("scannerVideo");

        html5QrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
                handleScanResult(qrCodeMessage);
            },
            errorMessage => {
                console.warn("QR Code scan error:", errorMessage);
            }
        ).catch(err => {
            console.error("Camera error:", err);
            alert("Cannot access camera!");
            closeScanner();
        });
    }

    function closeScanner() {
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "none";

        if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
                html5QrScanner.clear();
                html5QrScanner = null;
            }).catch(err => {
                console.error("Error stopping scanner", err);
            });
        }

        // âœ¨ å…³é—­æ‰«ç åï¼ŒæŠŠç•Œé¢æŒ‰é’®æ¢å¤å›æ¥
        showTopButtons();
        document.getElementById("healthBar").style.display = "block"; // è¡€æ¡ä¹Ÿè¦å•ç‹¬æ¢å¤
    }

    function showScanPrompt() {
        document.getElementById("scanNoticeModal").style.display = "flex";
    }

    function startScanPage() {
        document.getElementById("scanNoticeModal").style.display = "none";
    }

    function handleScanResult(result) {
        console.log("Scanned:", result);

        if (result === "boss_target") {
            if (inventory.includes("Boss")) {
                // â­ å¦‚æœå·²ç»æ‰“è´¥äº†Boss
                closeScanner();
                document.getElementById("kingModal").style.display = "flex"; 
            } else {
                // è¿˜æ²¡æ‰“è´¥ï¼Œæ­£å¸¸è¿›å…¥BossæŒ‘æˆ˜
                closeScanner();
                document.getElementById("bossEncounterModal").style.display = "flex"; 
            }
        } else if (result.startsWith("trap")) {
            closeScanner();
            
            health = 0;
            updateHearts();

            showTrapModal();
        } else {
            // å…¶ä»–æƒ…å†µï¼Œç»§ç»­æ‰«æ
        }
    }

    function showTrapModal() {
        document.getElementById("trapModal").style.display = "flex";
    }

    function handleTrapOk() {
        document.getElementById("trapModal").style.display = "none";

        // ä¸éœ€è¦æ£€æŸ¥è¡€é‡ï¼Œç›´æ¥Game Over
        document.getElementById("gameOverModal").style.display = "flex";
    }

    let bossHealth = 30;
    let maxBossHealth = 30;
    let bossBattleTimer = null;

    function startBossBattle() {
        document.body.style.touchAction = "manipulation"; // â­å¼€å§‹Bossæˆ˜æ–—æ—¶ç¦ç”¨ç¼©æ”¾
        // å…³é—­é‡åˆ°Bossçš„å¼¹çª—
        document.getElementById("bossEncounterModal").style.display = "none";
        // æ‰“å¼€Bossæˆ˜æ–—ç•Œé¢
        document.getElementById("bossBattleModal").style.display = "flex";

        hideTopButtons(); 

        // åˆå§‹åŒ–Bossè¡€é‡
        bossHealth = 30;
        maxBossHealth = 30; // â­ è¡¥ä¸Šè¿™ä¸€è¡Œï¼ï¼ˆå’Œç©å®¶è¡€é‡ä¸€æ ·ï¼‰

        updateBossBattleUI(); // åˆ·æ–°è¡€æ¡åˆ°æ»¡è¡€

        // â­ å¼€å§‹Bossæ”»å‡»å€’è®¡æ—¶ï¼šæ¯6ç§’æ‰£1æ»´è¡€
        bossBattleTimer = setInterval(() => {
            health = Math.max(0, health - 1);
            updateHearts();

            triggerScreenShake(); // â­ æ–°åŠ è¿™ä¸€è¡Œï¼ï¼

            if (health <= 0) {
                clearInterval(bossBattleTimer); // â­ è®°å¾—æ¸…é™¤è®¡æ—¶å™¨
                endBossBattle(false); // è¾“äº†
            }
        }, 3000);
    }

    function attackBoss() {
        if (bossHealth > 0) {
            bossHealth--;
            updateBossBattleUI(); // â¬…ï¸ è¡€æ¡åŒæ­¥åˆ·æ–°
        }

        // âœ¨ åŠ æ‰“å‡»ç‰¹æ•ˆ
        const bossImg = document.getElementById("bossImage");
        bossImg.style.animation = "bossHit 0.5s";
        bossImg.addEventListener("animationend", () => {
            bossImg.style.animation = "";
        }, { once: true });

        const attackButton = document.querySelector("#bossBattleModal button");
        attackButton.style.animation = "buttonPress 0.2s";
        attackButton.addEventListener("animationend", () => {
            attackButton.style.animation = "";
        }, { once: true });

        spawnExplosion(); // çˆ†ç‚¸ç‰¹æ•ˆ

        if (bossHealth <= 0) {
            endBossBattle(true); // ğŸ‰èƒœåˆ©
        }
    }


    function endBossBattle(victory) {
        clearInterval(bossBattleTimer);
        document.body.style.touchAction = "";  // â­ç»“æŸæ—¶æ¢å¤æ­£å¸¸ç¼©æ”¾ï¼

        document.getElementById("bossBattleModal").style.display = "none";

        showTopButtons();

        if (victory) {
            showVictoryModal();
        } else {
            document.getElementById("gameOverModal").style.display = "flex";
        }
    }

    function showVictoryModal() {
        if (document.getElementById("victoryModal")) return;

        // â­ åœ¨Victoryå¼¹çª—å‡ºç°å‰ï¼ŒæŠŠBossåŠ å…¥åˆ°inventory
        if (!inventory.includes("Boss")) {
            inventory.push("Boss");

            const inventoryContent = document.getElementById("inventoryContent");
            if (inventoryContent.innerHTML.includes("No tamed beasts yet.")) {
                inventoryContent.innerHTML = '';
            }
            inventoryContent.innerHTML += `
              <div style="display: inline-block; margin: 10px;">
                <img src="boss.png" style="width: 100px; height: 100px;">
                <p>Boss</p>
              </div>
            `;
        }

        const victoryModal = document.createElement("div");
        victoryModal.className = "modal";
        victoryModal.id = "victoryModal";
        victoryModal.innerHTML = `
          <div class="modal-content victory-animate" style="text-align: center;">
            <h2 style="font-size: 40px; color: gold;">ğŸ† YOU WIN!</h2>
            <p style="font-size: 24px;">You defeated the Boss!</p>
            <img src="boss_defeated.png" alt="Boss Defeated" style="width: 200px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.4);">
            <p style="font-size: 20px;">The world is safe because of you!</p>
            <button onclick="closeVictoryModal()">OK</button>
          </div>
        `;
        document.body.appendChild(victoryModal);
        victoryModal.style.display = "flex";

        // ğŸ‡ èƒœåˆ©çƒŸèŠ±ç²’å­ï¼ˆå¯ä»¥åé¢å†åŠ ï¼‰
        spawnExplosion(30);
    }

    function updateBossBattleUI() {
        const bossHealthBar = document.getElementById("bossHealthBar");
        const percentage = (bossHealth / maxBossHealth) * 100;
        bossHealthBar.style.width = `${percentage}%`;
    }

    function spawnExplosion(count = 10) {
        const explosionContainer = document.querySelector(".modal[style*='display: flex']") || document.body;

        for (let i = 0; i < count; i++) {
            const particle = document.createElement("div");
            particle.className = "explosion";

            // æ›´å¤§èŒƒå›´éšæœº
            const dx = (Math.random() - 0.5) * 400 + "px";
            const dy = (Math.random() - 0.5) * 400 + "px";

            particle.style.setProperty("--dx", dx);
            particle.style.setProperty("--dy", dy);

            // æ›´éšæœºåˆå§‹ä½ç½®
            particle.style.left = Math.random() * 100 + "%";
            particle.style.top = Math.random() * 100 + "%";

            explosionContainer.appendChild(particle);

            particle.addEventListener("animationend", () => {
                particle.remove();
            });
        }
    }

    function closeVictoryModal() {
        const victoryModal = document.getElementById("victoryModal");
        if (victoryModal) {
            victoryModal.remove();
        }
    }

    function triggerScreenShake() {
        document.body.classList.add('screen-shake');
        setTimeout(() => {
            document.body.classList.remove('screen-shake');
        }, 500); // è·ŸåŠ¨ç”»æ—¶é•¿ä¸€è‡´
    }

    function hideTopButtons() {
        document.getElementById("inventoryButton").style.display = "none";
        document.getElementById("clueButton").style.display = "none";
        document.getElementById("scanButton").style.display = "none";
    }

    function showTopButtons() {
        document.getElementById("inventoryButton").style.display = "block";
        document.getElementById("clueButton").style.display = "block";
        document.getElementById("scanButton").style.display = "block";
    }

    let beastSounds = {}; // ä¿å­˜æ¯ä¸ªbeastå¯¹åº”çš„éŸ³é¢‘å¯¹è±¡

    beasts.forEach(beast => {
      beastSounds[beast.name] = new Audio(beast.sound);
      beastSounds[beast.name].volume = 0.8;
    });

    let hasPlayedSound = {}; // è®°å½•æ¯ä¸ªbeastæ˜¯å¦æ’­æ”¾è¿‡å£°éŸ³
        beasts.forEach(beast => {
      hasPlayedSound[beast.name] = false;
    });



    function unlockAudio() {
      Object.values(beastSounds).forEach(audio => {
        audio.muted = true;
        audio.play().then(() => {
          audio.pause();
          audio.currentTime = 0;
          audio.muted = false;
        }).catch(err => {
          console.warn('Audio unlock failed', err);
        });
      });

      // âœ… æ–°å¢ï¼šè§£é” Goose çš„éŸ³é¢‘
      const gooseSound = document.getElementById("leftGooseSound");
      if (gooseSound) {
        gooseSound.muted = true;
        gooseSound.play().then(() => {
          gooseSound.pause();
          gooseSound.currentTime = 0;
          gooseSound.muted = false;
        }).catch(err => {
          console.warn('Goose audio unlock failed', err);
        });
      }
    }

    let soundEnabled = false; // æ ‡è®°ç”¨æˆ·æœ‰æ²¡æœ‰å…è®¸å£°éŸ³

    function enableSound() {
      unlockAudio();
      soundEnabled = true;
      document.getElementById("soundPromptModal").style.display = "none";
      showStartPointPrompt();
    }

    function disableSound() {
      soundEnabled = false;
      document.getElementById("soundPromptModal").style.display = "none";
      showStartPointPrompt();
    }

    // ã€é‡è¦ã€‘ä¿®æ”¹åŸæ¥çš„ window.onload
    window.onload = () => {
      // ä¸€å¼€å§‹å¼¹å‡ºå£°éŸ³æç¤ºï¼Œè€Œä¸æ˜¯ç›´æ¥åˆå§‹åŒ–åœ°å›¾
      document.getElementById("soundPromptModal").style.display = "flex";
    };

    // åŠ ä¸€ä¸ªæ–°çš„initGameå‡½æ•°ï¼Œåˆå§‹åŒ–åœ°å›¾ã€è¡€é‡
    function initGame() {
      initMap();
      updateHearts();
    }

    let beastSystemActivated = false;


    function showStartPointPrompt() {
      document.getElementById("startPointModal").style.display = "flex";
    }

    function closeStartPointModal() {
      document.getElementById("startPointModal").style.display = "none";
      initGame(); // ğŸ§¡ çœŸæ­£å¼€å§‹ç›‘æ§ç©å®¶ä½ç½®
    }

    function activateBeasts() {
      beasts.forEach(beast => {
        beast.activated = true;
        if (!beast.hidden) {
          markers[beast.name].addTo(map); // Wind Beastæ˜¾ç¤º
        }
        // Water Beastæ¿€æ´»ä½†æ˜¯ä¿æŒéšè—
      });
    }

    function closeInvestigationModal() {
      document.getElementById("investigationModal").style.display = "none";
      showTopButtons(); // å¯é€‰ï¼šæ¢å¤ç•Œé¢æŒ‰é’®
    }

    const gooseHintMarker = {
      lat: 52.9537823,    // æ›¿æ¢æˆä½ æŸ±å­å¤„çš„çº¬åº¦
      lng: -1.1881251,    // æ›¿æ¢æˆä½ æŸ±å­å¤„çš„ç»åº¦
      played: false
    };

  </script>
  <audio id="leftGooseSound" src="left_goose_call.mp3"></audio>
</body>
</html>
