<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Locative Media - Wind Beast Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial; }
    #map { height: 100%; }
    .modal {
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center;
    }
    .modal-content img {
      max-width: 100%;
      width: 160px;
      height: auto;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .modal-content button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
    }
    .modal-content button:hover { background-color: #388e3c; }
    #inventoryButton, #clueButton, #healthBar {
      position: absolute;
      z-index: 1000;
      background-color: #ffffffcc;
      border: 1px solid #999;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: bold;
      cursor: pointer;
    }

    #inventoryButton {
      top: 10px;
      left: 10px;
    }

    #clueButton {
      top: 60px; /* ç¨å¾®å¾€ä¸‹ï¼Œé¿å…è·ŸCardsæŒ‰é’®é‡å  */
      left: 10px;
    }

    #healthBar {
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    #scanButton {
        top: 110px;
        left: 10px;
        position: absolute;
        z-index: 1000;
        background-color: #ffffffcc;
        border: 1px solid #999;
        border-radius: 8px;
        padding: 6px 10px;
        font-weight: bold;
        cursor: pointer;
    }

    #closeScannerBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: none;
        font-size: 36px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001; /* é«˜äºvideo */
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="inventoryButton" onclick="toggleInventory()">ğŸ“¦ Cards</div>
  <div id="clueButton" onclick="toggleClues()">ğŸ§© Clues</div>
  <div id="scanButton" onclick="startScanner()">ğŸ“¸ Scan</div>
  <div id="healthBar"> <span id="hearts"></span></div>

  <div id="challengeModal" class="modal">
    <div class="modal-content">
      <h2>You encountered Wind Beast! ğŸŒ¬ï¸</h2>
      <img src="wind_beast.png" alt="Wind Beast" />
      <p>Do you accept the challenge?</p>
      <button onclick="acceptChallenge()">Accept Challenge</button>
      <button onclick="closeModal()">Run Away</button>
    </div>
  </div>

  <div id="quizModal" class="modal">
    <div class="modal-content">
      <h2 id="quizTitle">Quiz</h2>
      <p id="question"></p>
      <button onclick="answer(true)">True</button>
      <button onclick="answer(false)">False</button>
    </div>
  </div>

  <div id="puzzleModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ§© Solve the Puzzle to Tame Smart Goose!</h2>
      <h3 id="timer" style="margin-bottom: 10px;">â³ 60</h3>
      <div id="puzzleGrid" style="display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 2px; justify-content: center; margin-bottom: 20px;"></div>
      <button onclick="checkPuzzle()">Check</button>
      <button onclick="closeResultModal('puzzleModal')">Leave</button>
    </div>
  </div>


  <div id="successModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ‰ You Tamed Wind Beast!</h2>
      <img src="wind_beast.png" alt="Wind Beast" />
      <p>The wind flows with you now. Congratulations!</p>
      <button onclick="closeResultModal('successModal')">OK</button>
    </div>
  </div>

  <div id="failModal" class="modal">
    <div class="modal-content">
      <h2 id="failTitle">ğŸ˜¢ Challenge Failed</h2>
      <img id="failImage" src="wind_beast.png" alt="Beast" />
      <p id="failMessage">The Wind Beast slipped away. Try again later.</p>
      <button onclick="retryChallenge()">Retry</button>
      <button onclick="handleFailRetry()">Leave</button>
    </div>
  </div>

  <div id="gameOverModal" class="modal">
    <div class="modal-content">
      <h2>âŒ Game Over</h2>
      <p>Your journey ends here... for now.</p>
      <button onclick="restartGame()">Restart Game</button>
    </div>
  </div>

  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ“œ Your Beast Cards</h2>
      <div id="inventoryContent">
        <p>No tamed beasts yet.</p>
      </div>
      <button onclick="closeResultModal('inventoryModal')">Close</button>
    </div>
  </div>

  <div id="clueModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ§© Your Clues</h2>
      <div id="clueContent">
        <p>No clues collected yet.</p>
      </div>
      <button onclick="closeResultModal('clueModal')">Close</button>
    </div>
  </div>

  <div id="clueRewardModal" class="modal">
    <div class="modal-content">
      <h2 id="clueRewardTitle">ğŸ§© You found a clue!</h2>
      <img id="clueRewardImage" src="" alt="Clue Piece" />
      <p id="clueRewardText">Wind Beast left you a mysterious clue...</p>
      <button onclick="collectClue()">Collect</button>
    </div>
  </div>

  <div id="scanNoticeModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ“¸ Ready to Scan!</h2>
      <p>You have collected enough clues. Find and scan the hidden poster to summon the BOSS!</p>
      <button onclick="startScanPage()">OK</button>
    </div>
  </div>

  <div id="bossEncounterModal" class="modal">
    <div class="modal-content">
      <h2>You found the BOSS! ğŸ‘¹</h2>
      <img src="boss.png" alt="Boss" style="width: 200px; height: auto; margin: 20px 0;">
      <p>The final battle awaits. Are you ready?</p>
      <button onclick="startBossBattle()">Challenge Boss</button>
    </div>
  </div>

  <div id="trapModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ’€ Trap Triggered!</h2>
      <p>You fell into UoN King's trap!</p>
      <button onclick="handleTrapOk()">OK</button>
    </div>
  </div>

  <div id="scannerModal" class="modal" style="background: rgba(0,0,0,0.9);">
    <div id="scannerVideo" style="width: 100%; height: 100%;"></div>
    <button onclick="closeScanner()" id="closeScannerBtn">Ã—</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    let map, userMarker;
    let activeBeast = null; // tracks which beast you're challenging
    let quizStarted = false, hasEncountered = {}, health = 3, inventory = [], current = 0;

    const threshold = 20;
    const beasts = [
      {
        name: "Wind Beast",
        lat: 52.9518391,
        lng: -1.1873593,
        icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        image: "wind_beast.png",
        questions: [
          { q: "Wind Beast is a fire element?", a: false },
          { q: "Is Wind Beast smart?", a: true },
          { q: "Can Wind Beast be tamed by kindness?", a: true }
        ]
      },
      {
        name: "Fire dragon",
        lat: 52.9534064,
        lng: -1.1874079,
        icon: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
        image: "fire_dragon.png",
      }
    ];

    let markers = {}; // save markers by name

    function initMap() {
      map = L.map('map').setView([beasts[0].lat, beasts[0].lng], 17);
      L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png?api_key=724f6bff-ee73-4e21-97aa-b0f55c520723').addTo(map);

      const userIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize: [32, 32] });

      beasts.forEach(beast => {
        const marker = L.marker([beast.lat, beast.lng], {
          icon: L.icon({ iconUrl: beast.icon, iconSize: [32, 32] })
        }).addTo(map);

        markers[beast.name] = marker;

        marker.on('click', () => {
          if (!quizStarted && userMarker) {
            const dist = getDistance(userMarker.getLatLng(), marker.getLatLng());

            if (hasEncountered[beast.name]) {
              // âœ…å·²ç»é‡åˆ°è¿‡
              if (dist < threshold && !inventory.includes(beast.name)) {
                // â­ è·ç¦»å¤Ÿè¿‘ï¼Œç›´æ¥æŒ‘æˆ˜
                activeBeast = beast;
                document.querySelector('#challengeModal h2').textContent = `You encountered ${beast.name}!`;
                document.querySelector('#challengeModal img').src = beast.image;
                document.querySelector('#challengeModal').style.display = 'flex';
              } else {
                // ğŸ‘€ è·ç¦»å¤ªè¿œï¼Œæ˜¾ç¤ºæ­£å¸¸æç¤º
                marker.bindPopup(`${beast.name} is here. Come closer to challenge!`).openPopup();
              }
            } else {
              // ğŸ§©ä»æœªé‡åˆ°è¿‡ï¼Œåªèƒ½æ„ŸçŸ¥ç¥ç§˜æ„Ÿ
              marker.bindPopup(`You sense a mysterious presenceâ“`).openPopup();
            }
          }
        });
      });

      navigator.geolocation.watchPosition(
        pos => {
          const latlng = [pos.coords.latitude, pos.coords.longitude];

          if (!userMarker) {
            userMarker = L.marker(latlng, { icon: userIcon }).addTo(map).bindPopup("You are here").openPopup();
          } else {
            userMarker.setLatLng(latlng).update();
          }

          // å…³é”®ï¼ç›´æ¥setViewï¼Œå–æ¶ˆåŠ¨ç”»ï¼Œç¬é—´è·Ÿéš
          map.setView(latlng, map.getZoom(), { animate: false });

          // æ£€æŸ¥é™„è¿‘beasts
          beasts.forEach(beast => {
            const dist = getDistance(userMarker.getLatLng(), { lat: beast.lat, lng: beast.lng });
            if (dist < threshold && (hasEncountered[beast.name] === false || hasEncountered[beast.name] === undefined)) {
              hasEncountered[beast.name] = true; 
              activeBeast = beast;
              document.querySelector('#challengeModal h2').textContent = `You encountered ${beast.name}!`;
              document.querySelector('#challengeModal img').src = beast.image;
              document.querySelector('#challengeModal').style.display = 'flex';
            }
          });
        },
        err => {
          console.error("Geolocation error:", err);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        }
      );
    }

    function getDistance(a, b) {
      const R = 6371e3, toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const aCalc = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(aCalc), Math.sqrt(1-aCalc));
    }



    function closeModal() {
      document.getElementById("challengeModal").style.display = "none";
    }

    function showQuestion() {
      // è®¾ç½® quiz modal çš„æ ‡é¢˜ä¸ºå½“å‰ beast çš„åå­—
      document.querySelector("#quizModal h2").textContent = `ğŸ§  ${activeBeast.name} Quiz`;
      // è®¾ç½®é—®é¢˜å†…å®¹
      document.getElementById("question").textContent = activeBeast.questions[current].q;
    }

    function answer(ans) {
      if (ans === activeBeast.questions[current].a) {
        current++;
        if (current >= activeBeast.questions.length) return tameSuccess();
        return showQuestion();
      } else {
        document.getElementById("quizModal").style.display = "none";
        health = Math.max(0, health - 1);
        updateHearts();

        // ğŸ‘‡ åŠ¨æ€æ›´æ–°å¤±è´¥å¼¹çª—çš„å†…å®¹
        document.getElementById("failTitle").textContent = `ğŸ˜¢ Challenge Failed`;
        document.getElementById("failImage").src = activeBeast.image;
        document.getElementById("failMessage").textContent = `The ${activeBeast.name} slipped away. Try again later.`;

        quizStarted = false;
        if (health <= 0) {
          document.getElementById("gameOverModal").style.display = "flex";
        } else {
          document.getElementById("failModal").style.display = "flex";
        }
      }
    }

    function tameSuccess() {
        document.getElementById("quizModal").style.display = "none";
        document.querySelector("#successModal h2").textContent = `ğŸ‰ You Tamed ${activeBeast.name}!`;
        document.querySelector("#successModal img").src = activeBeast.image;
        document.getElementById("successModal").style.display = "flex";

        if (map.hasLayer(markers[activeBeast.name])) map.removeLayer(markers[activeBeast.name]);

        if (!inventory.includes(activeBeast.name)) {
            inventory.push(activeBeast.name);
            const inventoryContent = document.getElementById("inventoryContent");
            if (inventoryContent.innerHTML.includes("No tamed beasts yet.")) {
            inventoryContent.innerHTML = '';
            }
            inventoryContent.innerHTML += `<div style="display: inline-block; margin: 10px;"><img src="${activeBeast.image}" style="width: 100px; height: 100px;"><p>${activeBeast.name}</p></div>`;
        }

        quizStarted = false;
        hasEncountered[activeBeast.name] = "tamed";

        // â­ ç›‘å¬"OK"æŒ‰é’®ï¼Œå½“æˆåŠŸå¼¹çª—å…³é—­åï¼Œç«‹åˆ»å¼¹å‡ºçº¿ç´¢å¥–åŠ±
        const okButton = document.querySelector("#successModal button");
        okButton.onclick = () => {
            document.getElementById("successModal").style.display = "none";
            showClueReward();
        };
        }

    function retryChallenge() {
      document.getElementById("failModal").style.display = "none";
      acceptChallenge(); 
    }

    function handleFailRetry() {
      document.getElementById("failModal").style.display = "none";
    }

    function restartGame() { location.reload(); }

    function closeResultModal(id) {
      document.getElementById(id).style.display = "none";
    }

    function toggleInventory() {
      const inv = document.getElementById("inventoryModal");
      inv.style.display = inv.style.display === "flex" ? "none" : "flex";
    }
    function toggleClues() {
      const clue = document.getElementById("clueModal");
      clue.style.display = clue.style.display === "flex" ? "none" : "flex";
    }

    function updateHearts() {
      const hearts = document.getElementById("hearts");
      hearts.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        hearts.innerHTML += i < health ? 'â¤ï¸' : 'ğŸ¤';
      }
    }

    window.onload = () => {
      initMap();
      updateHearts();
    }
    
  const puzzlePieces = [];

  let selectedPiece = null;

  function selectPiece(piece) {
    if (!selectedPiece) {
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œé€‰ä¸­
      selectedPiece = piece;
      piece.style.border = "2px solid red"; // æ˜¾ç¤ºçº¢è‰²è¾¹æ¡†ä½œä¸ºæç¤º
    } else {
      // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œäº¤æ¢ä½ç½®
      const tempPos = selectedPiece.style.backgroundPosition;
      selectedPiece.style.backgroundPosition = piece.style.backgroundPosition;
      piece.style.backgroundPosition = tempPos;

      selectedPiece.style.border = "none";
      piece.style.border = "none";

      selectedPiece = null; // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
    }
  }

  function startPuzzleChallenge() {
    disableMapInteraction(); // â­ åŠ è¿™è¡Œ
    const puzzleGrid = document.getElementById("puzzleGrid");
    puzzleGrid.innerHTML = "";
    puzzlePieces.length = 0;

    for (let i = 0; i < 9; i++) {
      const piece = document.createElement("div");
      piece.style.width = "100px";
      piece.style.height = "100px";
      piece.style.backgroundImage = "url('fire_dragon.png')"; // âœ…æ”¹å°å†™
      piece.style.backgroundSize = "300px 300px";
      piece.style.backgroundPosition = `${-(i % 3) * 100}px ${-Math.floor(i / 3) * 100}px`;
      piece.dataset.index = i;
      piece.onclick = () => selectPiece(piece); // â­ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶
      puzzlePieces.push(piece);
    }

    shuffleArray(puzzlePieces);
    puzzlePieces.forEach(p => puzzleGrid.appendChild(p));

    document.getElementById("puzzleModal").style.display = "flex";

    quizStarted = true;
    startTimer();
  }

  function dragStart(e) {
    e.dataTransfer.setData("text/plain", e.target.dataset.index);
  }

  function drop(e) {
    const fromIdx = e.dataTransfer.getData("text/plain");
    const toIdx = e.target.dataset.index;
    const parent = e.target.parentElement;
    const fromEl = puzzlePieces[fromIdx];
    const toEl = puzzlePieces[toIdx];

    // Swap in DOM
    const temp = fromEl.cloneNode(true);
    parent.replaceChild(temp, toEl);
    parent.replaceChild(toEl, fromEl);

    // Re-bind drag events
    parent.childNodes.forEach((child, i) => {
      child.dataset.index = i;
      child.ondragstart = dragStart;
      child.ondragover = e => e.preventDefault();
      child.ondrop = drop;
      puzzlePieces[i] = child;
    });
  }


  let timerInterval; // è®¡æ—¶å™¨å¥æŸ„
  let remainingTime = 60; // å‰©ä½™æ—¶é—´ï¼Œç§’

  function startTimer() {
    remainingTime = 60;
    document.getElementById("timer").textContent = `â³ ${remainingTime}`;
    clearInterval(timerInterval); // é˜²æ­¢å¤šå¼€

    timerInterval = setInterval(() => {
      remainingTime--;
      document.getElementById("timer").textContent = `â³ ${remainingTime}`;
      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        checkPuzzle(true); // æ—¶é—´åˆ°äº†è‡ªåŠ¨æ£€æŸ¥
      }
    }, 1000);
  }

  // isAuto è¡¨ç¤ºæ˜¯ä¸æ˜¯è‡ªåŠ¨æ£€æŸ¥
  function checkPuzzle(isAuto = false) {
    clearInterval(timerInterval); // æ— è®ºæ€æ ·éƒ½åœæ‰è®¡æ—¶å™¨
    enableMapInteraction();   // æ¢å¤åœ°å›¾äº¤äº’

    const correctOrder = [0,1,2,3,4,5,6,7,8];
    const currentOrder = Array.from(document.getElementById("puzzleGrid").children).map(el => {
      const bgPos = el.style.backgroundPosition;
      const x = parseInt(bgPos.split(" ")[0]) * -1 / 100;
      const y = parseInt(bgPos.split(" ")[1]) * -1 / 100;
      return y * 3 + x;
    });

    const isCorrect = currentOrder.every((val, idx) => val === correctOrder[idx]);

    if (isCorrect) {
      document.getElementById("puzzleModal").style.display = "none";
      tameSuccess();
    } else {
      document.getElementById("puzzleModal").style.display = "none";
      health = Math.max(0, health - 1);
      updateHearts();
      document.getElementById("failTitle").textContent = `ğŸ˜¢ Puzzle Failed`;
      document.getElementById("failImage").src = activeBeast.image;
      document.getElementById("failMessage").textContent = isAuto 
        ? `Time's up! ${activeBeast.name} slipped away.` 
        : `Wrong puzzle arrangement! ${activeBeast.name} slipped away.`;

      if (health <= 0) {
        document.getElementById("gameOverModal").style.display = "flex";
      } else {
        document.getElementById("failModal").style.display = "flex";
      }
      quizStarted = false;
    }
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Update the acceptChallenge() logic to launch quiz or puzzle based on beast
  function acceptChallenge() {
    document.getElementById("challengeModal").style.display = "none";
    current = 0; // é‡ç½®é—®é¢˜ç´¢å¼•

    if (activeBeast.name === "Fire dragon") {
      startPuzzleChallenge();
    } else {
      quizStarted = true;
      document.getElementById("quizModal").style.display = "flex";
      showQuestion();
    }
  }

  function disableMapInteraction() {
    map.dragging.disable();
    map.scrollWheelZoom.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
  }

  function enableMapInteraction() {
    map.dragging.enable();
    map.scrollWheelZoom.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
  }
  let collectedClues = []; // ä¿å­˜å·²ç»è·å¾—çš„çº¿ç´¢ç¢ç‰‡
    const clues = {
    "Wind Beast": "clue2.png",
    "Fire dragon": "clue1.png"
    };

    function showClueReward() {
        const clueImg = clues[activeBeast.name];
        if (clueImg && !collectedClues.includes(clueImg)) {
            document.getElementById("clueRewardImage").src = clueImg;
            document.getElementById("clueRewardText").textContent = `${activeBeast.name} gave you a clue piece!`;
            document.getElementById("clueRewardModal").style.display = "flex";
        }
        }

    let scanPromptShown = false;    
    function collectClue() {
        const clueImg = document.getElementById("clueRewardImage").src;
        collectedClues.push(clueImg);

        const clueContent = document.getElementById("clueContent");
        if (clueContent.innerHTML.includes("No clues collected yet.")) {
            clueContent.innerHTML = '';
        }
        clueContent.innerHTML += `<div style="display: inline-block; margin: 10px;"><img src="${clueImg}" style="width: 100px; height: 100px;"></div>`;

        document.getElementById("clueRewardModal").style.display = "none";

        // ğŸ§©â­ã€æ–°å¢ã€‘æ”¶é›†ä¸¤ä¸ªçº¿ç´¢åæç¤ºå¯ä»¥å»æ‰«æ
        if (collectedClues.length >= 2 && !scanPromptShown) {
            scanPromptShown = true;
            showScanPrompt();
        }
    }

    let html5QrScanner = null; // ä¿å­˜scannerå¯¹è±¡

    function startScanner() {
        if (html5QrScanner) {
            // å¦‚æœscannerå·²ç»æ‰“å¼€äº†ï¼Œå°±ä¸è¦é‡å¤æ‰“å¼€
            return;
        }
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "flex";

        html5QrScanner = new Html5Qrcode("scannerVideo");

        html5QrScanner.start(
            { facingMode: "environment" }, // ç›´æ¥ç”¨åç½®æ‘„åƒå¤´ï¼Œä¸åˆ—è®¾å¤‡äº†
            { fps: 10, qrbox: 250 },        // å¯è°ƒå¸§ç‡å’Œæ‰«ç åŒºåŸŸå¤§å°
            qrCodeMessage => {
                handleScanResult(qrCodeMessage);
            },
            errorMessage => {
                // è¿™é‡Œå¯ä»¥é€‰æ‹©å¿½ç•¥è¯†åˆ«å¤±è´¥çš„é”™è¯¯ï¼Œä¸å¼¹çª—
                console.warn("QR Code scan error:", errorMessage);
            }
        ).catch(err => {
            console.error("Camera error:", err);
            alert("Cannot access camera!");
            closeScanner();
        });
    }

    function closeScanner() {
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "none";

        if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
                html5QrScanner.clear();
                html5QrScanner = null;
            }).catch(err => {
                console.error("Error stopping scanner", err);
            });
        }
    }

    function showScanPrompt() {
        document.getElementById("scanNoticeModal").style.display = "flex";
    }

    function startScanPage() {
        document.getElementById("scanNoticeModal").style.display = "none";
    }

    function handleScanResult(result) {
        console.log("Scanned:", result);

        if (result === "boss_target") {
            closeScanner();
            document.getElementById("bossEncounterModal").style.display = "flex"; // æ˜¾ç¤ºBossæŒ‘æˆ˜å¼¹çª—
        } else if (result.startsWith("trap")) {
            closeScanner();
            
            // æ‰«åˆ°é™·é˜±ç›´æ¥æ‰£å…‰è¡€ï¼
            health = 0;
            updateHearts();

            // å¼¹å‡ºé™·é˜±æç¤ºå¼¹çª—
            showTrapModal();
        } else {
            // å…¶ä»–æƒ…å†µï¼Œç»§ç»­æ‰«æ
        }
    }

    function showTrapModal() {
        document.getElementById("trapModal").style.display = "flex";
    }

    function handleTrapOk() {
        document.getElementById("trapModal").style.display = "none";

        // ä¸éœ€è¦æ£€æŸ¥è¡€é‡ï¼Œç›´æ¥Game Over
        document.getElementById("gameOverModal").style.display = "flex";
    }



  </script>
</body>
</html>
